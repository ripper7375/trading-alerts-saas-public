The failing test is Indicators API Routes › GET /api/indicators/[symbol]/[timeframe] › should return indicator data for FREE tier with valid symbol/timeframe, from **tests**/api/indicators.test.ts at line 369. The failure occurs when verifying that a response to a valid FREE tier request (e.g., XAUUSD/H1) returns status 200, success: true, and matching data.

After reviewing the test and the implementation in app/api/indicators/[symbol]/[timeframe]/route.ts (ref: e6ad77f04796f96d0b329545bb9a6d2b294cd065), possible causes and fixes include:

1. **Incorrect Access Logic:** If canAccessSymbol or canAccessTimeframe incorrectly restricts FREE tier access, ensure the tier symbols and timeframes in /lib/tier-config are up to date, and that these validation functions match expected access.
2. **Parameter Normalization:** Make sure both symbol and timeframe (e.g., "XAUUSD"/"H1") are normalized to uppercase before validation and downstream calls, as required by your schemas and the fetchIndicatorData mock. The current implementation runs safeParse and saves result as upperSymbol/upperTimeframe, which is correct. If the functions referenced elsewhere use non-normalized versions, update all instances to use upperSymbol and upperTimeframe.
3. **Mock Data Alignment:** The test expects a certain "proIndicatorsTransformed" field in the response. Ensure that, both in your code and test mock, this is present in the returned data, and that fields/data structures match.

**Code Fix Suggestions:**

- In [route.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/e6ad77f04796f96d0b329545bb9a6d2b294cd065/app/api/indicators/[symbol]/[timeframe]/route.ts), confirm the following for symbol/timeframe normalization:

  ```typescript
  const symbolResult = symbolSchema.safeParse(rawSymbol);
  ...
  const upperSymbol = symbolResult.data; // Use upperSymbol in all checks and data-fetching
  ...
  const timeframeResult = timeframeSchema.safeParse(rawTimeframe);
  ...
  const upperTimeframe = timeframeResult.data; // Likewise
  ```

  Use only `upperSymbol` and `upperTimeframe` after this point for all subsequent validations and when passing to fetchIndicatorData.

- Ensure the value returned from fetchIndicatorData has the exact shape expected by your test (notably, all expected top-level fields and especially proIndicatorsTransformed).

- If “proIndicatorsTransformed” can be undefined, ensure your return object always includes it, for example:

  ```typescript
  const proIndicatorsTransformed =
    transformProIndicators(data.proIndicators, userTier) || {};
  ```

- Double-check access logic in canAccessSymbol for FREE/PRO tiers and make sure your FREE symbols and timeframes arrays in tier-config are correct.

Make these adjustments and rerun the test. This will address the most likely causes for a mismatch in returned status/success/data, especially for tier restriction and data normalization issues.
