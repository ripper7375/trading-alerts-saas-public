I'll analyze the failing job to find a solution for you. Let me fetch the problematic file to understand the type issues: ## Solution for TypeScript Compilation Failures

The type-check job is failing due to missing Prisma includes and type mismatches. Here are the fixes:

### 1. Fix `app/api/disbursement/affiliates/[affiliateId]/commissions/route.ts`

**Problem:** Line 72 - `subscription` include is invalid, and properties `commissionType` and `tier` don't exist on the returned type.

**Solution:** Update the Prisma query to properly include the subscription relation and ensure the Commission model includes these fields:

```typescript
// Lines 64-82:  Update the query
const commissions = await prisma.commission.findMany({
  where: {
    affiliateProfileId: affiliateId,
    status: status as 'PENDING' | 'APPROVED' | 'PAID' | 'CANCELLED',
    disbursementTransaction: null,
  },
  include:  {
    // Remove the nested select, use plain include
    user: {
      select: { email: true }
    }
  },
  orderBy:  { createdAt: 'desc' },
  take: limit,
});

// Lines 109-115: Access properties directly from commission
type:  comm.commissionType,
tier: comm.tier ??  1,
status: comm.status,
createdAt: comm.createdAt,
referredUser: comm.user?.email ?? 'Unknown',
// Remove subscription references since they're not in the include
```

Alternatively, if subscriptions should be included, verify your Prisma schema has the subscription relation defined on the Commission model.

### 2. Fix `app/api/disbursement/affiliates/[affiliateId]/route.ts`

**Problem:** Lines 33, 46-47, 52, 97-131 - Similar issues with includes and missing properties.

**Solution:**

```typescript
// Line 33: Remove unused parameter
export async function GET(
  _request: NextRequest, // Add underscore prefix
  { params }: RouteParams
): Promise<NextResponse> {

// Lines 43-61: Fix the include structure
const profile = await prisma.affiliateProfile.findUnique({
  where: { id: affiliateId },
  include: {
    user: { select: { email: true, name: true, createdAt: true } },
    riseAccount: true,
    commissions: {
      where: { status: 'APPROVED' },
      orderBy: { createdAt: 'desc' },
      include:  {
        user: { select: { email: true } }
      },
    },
  },
});

// Lines 131-140: Update to use user instead of subscription
pendingCommissions: profile. commissions.map((comm) => ({
  id: comm.id,
  amount: Number(comm.commissionAmount),
  currency: 'USD',
  type: comm.commissionType,
  status: comm.status,
  createdAt: comm.createdAt,
  referredUser: comm.user?.email ?? 'Unknown',
  referredTier:  'Unknown', // Or remove if not available
})),
```

### 3. Fix `lib/disbursement/services/transaction-logger.ts`

**Problem:** Line 41 - Type mismatch for `details` field expecting `InputJsonValue`.

**Solution:**

```typescript
// Line 41: Cast to the correct Prisma JSON type
details: entry.details as any ??  {},
```

Or more type-safe:

```typescript
details: entry.details ?  JSON.parse(JSON.stringify(entry.details)) : {},
```

### 4. Fix other unused parameters

Add underscore prefix to unused `request` parameters throughout:

- Line 27 in `app/api/disbursement/affiliates/payable/route.ts`
- Line 38 in `app/api/disbursement/batches/[batchId]/execute/route.ts`
- Line 34 and 174 in `app/api/disbursement/batches/[batchId]/route.ts`
- Line 29 in `app/api/disbursement/riseworks/sync/route.ts`

### 5. Fix `app/api/disbursement/riseworks/accounts/route.ts`

**Problem:** Lines 109-110 - Index signature access errors.

**Solution:**

```typescript
// Use bracket notation
kycStatus: riseStatusToKycMap['APPROVED'],
kycStatus: riseStatusToKycMap['PENDING'] ??  riseStatusToKycMap['SUBMITTED'],
```

The main issue is that your Commission model's relationships and fields don't match what the code expects. Verify your Prisma schema includes `commissionType`, `tier`, and the proper relations to `user` or `subscription`.
