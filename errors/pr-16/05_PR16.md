I'll analyze the failing job to find a solution for you. Let me examine the failing test file to understand what's causing these failures: ## Solution for Failing E2E Tests

The test failures are occurring because the `validateDiscountCode` helper function is returning `undefined` instead of an object with the expected properties. Looking at **line 157** in the test file, the function is being called but the result isn't properly destructured.

### Root Cause

The `validateDiscountCode` function at lines 554-604 is an async function, but the test expectations are trying to access properties on `undefined` values. The multi-country support tests (lines 352-394) are also failing with similar `undefined` errors on line 515.

### Fix for Complete Checkout Flow Test (Line 67-132)

The issue at line 157 is that `validateDiscountCode` needs to properly await and handle the result:

```typescript
// Current code around line 157:
const discountResult = await validateDiscountCode(discountCode, planType);
expect(discountResult.valid).toBe(true);
expect(discountResult.discountPercent).toBe(10);
```

This should work, but ensure the mock at line 149 is properly set up before calling the function.

### Fix for Multi-Country Support Tests (Line 336-394)

The main issue is at **line 515** where `mockPrisma.user.update` is being checked but the test at lines 352-394 doesn't set up the necessary mocks for the `createPayment` function to work properly. Add these mocks before the payment creation:

```typescript
it.each(testCases)(
  'should support payment flow for $country',
  async ({ country, currency, expectedMethods }) => {
    // ...  existing code ...

    // Add these mocks before payment creation (before line 380):
    (mockPrisma.user.findUnique as jest.Mock).mockResolvedValue({
      id: `user-${country}`,
      email: `test@${country}.com`,
    });

    (mockPrisma.payment.create as jest.Mock).mockResolvedValue({
      id: 'test-payment-id',
      paymentId: 'dlocal-payment-id',
      orderId: 'test-order-id',
      status: 'PENDING',
    });

    // Verify payment creation works
    const payment = await createPayment({
      userId: `user-${country}`,
      amount: 29.0,
      currency,
      country,
      paymentMethod: expectedMethods[0],
      planType: 'MONTHLY',
    });

    expect(payment.paymentId).toBeDefined();
    expect(payment.status).toBe('PENDING');

    clearExchangeRateCache();
  }
);
```

### Additional Fix for Line 515

The test at lines 506-519 expects `mockPrisma.user.update` to be called, but it needs to be set up properly:

```typescript
it('should mark 3-day plan as used after purchase', async () => {
  const userId = 'mark-used-user';

  (mockPrisma.user.update as jest.Mock).mockResolvedValue({
    id: userId,
    hasUsedThreeDayPlan: true,
  });

  await markThreeDayPlanUsed(userId);

  // Fix:  Ensure the mock was called with correct parameters
  expect(mockPrisma.user.update).toHaveBeenCalledWith({
    where: { id: userId },
    data: { hasUsedThreeDayPlan: true },
  });
});
```

The key issue is that the `createPayment` function in the multi-country tests needs database mocks to return valid objects instead of undefined. Add the mock setups shown above to resolve all 12 failing tests.
