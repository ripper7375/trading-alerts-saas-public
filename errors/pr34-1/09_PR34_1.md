I'll analyze the failing job to find a solution for you. The TypeScript type-check is failing with multiple errors. Let me examine the affected files to provide solutions: ## Solution for TypeScript Compilation Errors

The job is failing due to multiple TypeScript errors. Here are the fixes needed:

### 1. **app/api/admin/users/route.ts (Line 46)**

Remove the unused `PrismaUserWithCounts` interface:

```typescript
// Delete lines 46-58
interface PrismaUserWithCounts {
  id: string;
  name: string | null;
  email: string;
  tier: string;
  role: string;
  isActive: boolean;
  createdAt: Date;
  _count: {
    alerts: number;
    watchlists: number;
  };
}
```

### 2. **lib/cron/check-expiring-subscriptions.ts (Lines 103, 120-122, 129)**

Add null checks for `subscription.user`:

```typescript
// Replace line 103
if (!subscription.user || !subscription.user.email || !subscription.expiresAt) {

// Replace lines 119-126
result.reminders.push({
  userId: subscription.user! .id,
  email: subscription.user!.email,
  name: subscription.user!.name,
  expiresAt: subscription.expiresAt,
  subscriptionId: subscription.id,
  planType: subscription.planType,
});

logger.info('Renewal reminder marked for sending', {
  userId:  subscription.user! .id,
  subscriptionId: subscription.id,
  expiresAt: subscription.expiresAt,
  dryRun,
});
```

### 3. **lib/cron/downgrade-expired-subscriptions.ts (Lines 127-129)**

Add null checks for `subscription.user`:

```typescript
// Replace lines 126-132
if (subscription.user) {
  result.downgrades.push({
    userId: subscription.user.id,
    email: subscription.user.email,
    name: subscription.user.name,
    subscriptionId: subscription.id,
    expiredAt: subscription.expiresAt,
  });
}
```

### 4. **lib/cron/monthly-distribution. ts (Lines 101, 108, 110)**

Add null checks for `affiliate.user`:

```typescript
// Replace lines 92-111
for (const affiliate of affiliates) {
  try {
    if (!affiliate.user) {
      result.errors.push(`Affiliate ${affiliate.id}:  Missing user`);
      continue;
    }

    await distributeCodes(
      affiliate.id,
      AFFILIATE_CONFIG.CODES_PER_MONTH,
      'MONTHLY'
    );

    result.distributed++;
    console.log(
      `[CRON] Distributed ${AFFILIATE_CONFIG.CODES_PER_MONTH} codes to ${affiliate.user.email}`
    );

    result.emailsSent++;
  } catch (error) {
    const errorMessage =
      error instanceof Error ? error.message : 'Unknown error';
    const errorEntry = affiliate.user
      ? `${affiliate.user.email}: ${errorMessage}`
      : `Affiliate ${affiliate.id}: ${errorMessage}`;
    result.errors.push(errorEntry);
    console.error(
      `[CRON] Failed to distribute to ${affiliate.user?.email || affiliate.id}:`,
      error
    );
  }
}
```

These changes address all the TypeScript strict null checking errors by either removing unused code or properly handling potentially undefined values from Prisma relations.
