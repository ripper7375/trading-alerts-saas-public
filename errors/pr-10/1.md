Findings (from job 58537134252)

- The run failed 2 test suites: **tests**/api/affiliate-conversion.test.ts and **tests**/api/affiliate-dashboard.test.ts. The trace shows the immediate failing assertion in affiliate-conversion is the "should normalize code to uppercase" test.
- Logs show many console.error messages from routes handling DB/auth errors (these are test assertions logging expected error flows) and Codecov upload failures — the immediate CI failure is the test failures (exit code 1).
- I inspected the failing test file at:
  https://github.com/ripper7375/trading-alerts-saas-public/blob/35f091b00b5fdcc3403020d2470fdeb8e98d81dc/__tests__/api/affiliate-conversion.test.ts

Root cause

- The "normalize code to uppercase" test expects the route to uppercase the incoming code before calling prisma.findUnique. The route implementation under app/api/checkout/validate-code/route.ts is likely not normalizing the code to uppercase (or not consistently doing so), so prisma is being queried with the lowercase input and the test assertion fails.
- The affiliate-dashboard test failure indicates the dashboard API route currently returns a non-401 response when an unauthenticated request is made (or its auth check is incorrect). Tests expect a 401 when not authenticated.

Concrete fixes and code suggestions

1. Ensure validate-code route normalizes the incoming code to uppercase and trims whitespace before querying Prisma, and that discount math uses consistent rounding to produce the expected numbers.

Patch idea (replace or update app/api/checkout/validate-code/route.ts):

- Normalize input:
  - const code = (body.code ?? '').toString().trim().toUpperCase();
- Validate length against CODE_GENERATION.CODE_LENGTH (8) or other rules.
- Use the normalized code in prisma.findUnique({ where: { code } }).
- When computing discount amounts, ensure consistent rounding (e.g., round to two decimals with Number((...).toFixed(2))).

Example snippet to apply (integrate into your route handler):

```ts
// Read body and normalize
const body = await request.json();
const codeInput = (body.code ?? '').toString();
const normalizedCode = codeInput.trim().toUpperCase();

// Basic format check (example using CODE_GENERATION.CODE_LENGTH = 8)
if (!normalizedCode || normalizedCode.length !== CODE_GENERATION.CODE_LENGTH) {
  return NextResponse.json(
    { valid: false, code: 'INVALID_FORMAT' },
    { status: 400 }
  );
}

// Query prisma with normalized code
const affiliateCode = await prisma.affiliateCode.findUnique({
  where: { code: normalizedCode },
  include: { affiliateProfile: true },
});

// Example discount calculation with stable rounding
const regularPrice = AFFILIATE_CONFIG.BASE_PRICE_USD;
const amount = Number((regularPrice * (discountPercent / 100)).toFixed(2));
const finalPrice = Number((regularPrice - amount).toFixed(2));
```

2. Ensure the route handles DB errors the same way tests expect

- Tests expect a 500 and body { valid: false, code: 'VALIDATION_ERROR' } when the DB call rejects. Confirm your catch block returns that exact shape/status.

Example catch:

```ts
} catch (error) {
  console.error('[Validate Code] Error:', error);
  return NextResponse.json({ valid: false, code: 'VALIDATION_ERROR' }, { status: 500 });
}
```

3. Fix affiliate dashboard route to return 401 for unauthenticated requests

- In app/api/affiliate/... (the dashboard route), ensure you check authentication/session and return:
  NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
- Use the same behavior the tests expect (they assert for 401). If you use next-auth/getServerSession or another auth helper, ensure that when it returns null/undefined you return the 401 response immediately before doing any DB access.

Example:

```ts
const session = await getServerSession(...);
if (!session) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

4. Run targeted tests locally to confirm fixes

- Run only the failing tests while developing:
  - npx jest **tests**/api/affiliate-conversion.test.ts -i
  - npx jest **tests**/api/affiliate-dashboard.test.ts -i
- Or run the specific test names if needed.

Why this will fix the CI failures

- Uppercasing before prisma.findUnique ensures the test that checks that the DB call used an uppercase code will pass.
- Returning 401 for unauthenticated dashboard requests matches the test expectation and prevents the failing assertion.
- Returning the exact error body/status for DB errors matches the tests that assert expected error codes.

Notes / small clarifications

- The affiliate-conversion tests expect amounts like 5.8 and 23.2. Use Number((...).toFixed(2)) to avoid floating-point differences in test comparisons.
- The failing job also shows Codecov token and coverage report errors; those are separate (upload/config issues) and do not cause the test suite failure, but will still emit CI warnings/errors after tests pass. Addressing Codecov requires configuring an upload token or skipping tokenless upload in CI.

Next steps (apply and verify)

1. Update app/api/checkout/validate-code/route.ts to normalize code and apply stable rounding as shown.
2. Update the affiliate dashboard route to return 401 for unauthenticated requests.
3. Run the two tests locally as noted and then push changes.
4. Re-run CI — the test failures should be resolved; then address Codecov configuration if you still want coverage uploads.

If you want, I can generate a precise patch/diff for app/api/checkout/validate-code/route.ts and the affiliate dashboard route given the repository layout.
