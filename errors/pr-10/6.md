Summary

- Job 58537121467 failed because two API-route tests returned the wrong behavior:
  1. **tests**/api/affiliate-conversion.test.ts — "should normalize code to uppercase" failed because the route did not normalize the submitted code to uppercase before querying the DB.
  2. **tests**/api/affiliate-dashboard.test.ts — "should return 401 when not authenticated" indicates the dashboard route returned a 200/other response instead of a 401 when the request was unauthenticated.

Root cause and solution (concrete)

1. Normalize affiliate code to uppercase before querying

- The failing test (see **tests**/api/affiliate-conversion.test.ts at ref 35f091b00b5fdcc3403020d2470fdeb8e98d81dc) explicitly asserts that the code passed to prisma.findUnique uses an uppercased version of the input:
  expect(mockAffiliateCodeFindUnique).toHaveBeenCalledWith(expect.objectContaining({ where: { code: 'LOWER123' } }))

- Fix: ensure the POST /api/checkout/validate-code route uppercases and trims the incoming code before validation and before calling prisma. Also defensively coerce to string.

Patch suggestion (replace or modify app/api/checkout/validate-code/route.ts)

- Add normalization immediately after parsing the request body and before any validation/database calls.

Example code to apply:

const body = await request.json();
const rawCode = body?.code ?? '';
const code = String(rawCode).trim().toUpperCase(); // normalize here

// then use `code` in validation and DB query:
if (!code) {
return NextResponse.json({ valid: false, code: 'CODE_REQUIRED' }, { status: 400 });
}
// replace any use of body.code or rawCode in prisma calls with `code`
const found = await prisma.affiliateCode.findUnique({ where: { code } });

Notes:

- Keep validation logic the same (length checks, allowed charset) but always run those checks on the normalized `code`.
- If your code-length/charset checks rely on length == CODE_GENERATION.CODE_LENGTH, validate against the normalized string.

2. Make unauthenticated affiliate dashboard requests return 401

- The failing dashboard test expects a 401 when no authenticated user is present. Make sure the dashboard route checks the current user/session and returns NextResponse.json(..., { status: 401 }) when there is no authenticated user.

Example pattern to use (app/api/affiliate/dashboard/.../route.ts):

import { NextResponse } from 'next/server';
import { getCurrentUser } from '@/lib/auth'; // adjust to your auth helper

export async function GET(request: Request) {
const user = await getCurrentUser(request); // or however you obtain session
if (!user) {
return NextResponse.json({ message: 'Unauthorized' }, { status: 401 });
}

// existing behavior when authenticated...
}

If your route already uses a helper to get the current user, confirm:

- The helper returns null/undefined when unauthenticated in test environment.
- You are checking for that and returning a 401 (not returning a 200 with an error payload).

Why this fixes the tests

- The conversion test asserts that prisma.findUnique gets called with uppercase code. Normalizing the code before the DB call satisfies that expectation.
- The dashboard test expects a 401 for unauthenticated requests; explicitly returning 401 when no user is present satisfies that expectation.

Additional notes and tips

- Tests use mocked global Request/Headers and mock NextResponse.json. Make sure your route uses the same flow (i.e., uses request.json() to read the body and NextResponse.json to return responses). The test file at ref 35f091b00b5fdcc3403020d2470fdeb8e98d81dc shows how Request/NextResponse are mocked.
- If you use destructuring like const { code } = await request.json(), ensure you still uppercase/trim the extracted code. Do not rely purely on the DB layer for normalization.
- Run tests locally after applying changes:
  - npm test (or the project’s test script, e.g. pnpm test or yarn test)
  - Or run the specific tests: jest **tests**/api/affiliate-conversion.test.ts -i

Commit message suggestions

- "fix(api/checkout): normalize incoming affiliate code to uppercase before validation"
- "fix(api/affiliate-dashboard): return 401 when unauthenticated"

If you want, I can produce a full diff for the route file(s) using the repo ref 35f091b00b5fdcc3403020d2470fdeb8e98d81dc and show an exact patch to apply.
