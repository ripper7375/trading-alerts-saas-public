I inspected the job logs for run/job 58537123642 (ref: 35f091b00b5fdcc3403020d2470fdeb8e98d81dc). Two test suites failed:

- **tests**/api/affiliate-conversion.test.ts
  - Failing test: POST /api/checkout/validate-code › should normalize code to uppercase
  - Failure indicates the API is returning a value that is not uppercase.

- **tests**/api/affiliate-dashboard.test.ts
  - Failing test: GET /api/affiliate/dashboard/codes › should return 401 when not authenticated
  - Failure indicates the route is returning a success (or different status) instead of 401.

Below are focused fixes and code snippets to apply. After making the changes, run the test suite (npm/yarn test) and re-run the CI job.

1. Ensure checkout code is normalized to uppercase (fix for validate-code endpoint)
   Problem: The API accepts codes but does not normalize them before validating/looking them up, while the tests expect normalization to uppercase.

Suggested fix (Next.js app route / API handler style):

- Normalize the incoming code early in the handler: trim and toUpperCase() before any DB lookup or response.
- Use a defensive default when code is missing.

Example (app router route.ts or a standard Next API handler — adapt to your framework):

// For Next.js app route (route.ts)
import { NextResponse } from 'next/server';

export async function POST(request: Request) {
const body = await request.json();
const code = (body?.code ?? '').toString().trim().toUpperCase();

if (!code) {
return NextResponse.json({ error: 'Missing code' }, { status: 400 });
}

// Example DB lookup (adjust to your ORM)
// const affiliate = await prisma.affiliateCode.findUnique({ where: { code } });

// return NextResponse.json({ valid: !!affiliate, code }); // code will be uppercase
// ...rest of logic
}

Example for pages/api (Node/Express-like) style:

export default async function handler(req, res) {
if (req.method !== 'POST') return res.status(405).end();

const code = (req.body?.code ?? '').toString().trim().toUpperCase();

if (!code) return res.status(400).json({ error: 'Missing code' });

// const affiliate = await prisma.affiliateCode.findUnique({ where: { code } });
// res.json({ valid: Boolean(affiliate), code });
}

Checklist:

- Verify every code path that reads req.body.code or query param uses the normalized version.
- Update any helper functions that parse / validate codes to return uppercase as canonical form.
- Update DB queries to compare with the normalized code (uppercase) rather than raw input.
- Add unit tests (or update) to ensure normalization: input 'abc123' returns code 'ABC123'.

2. Return 401 for unauthenticated requests to affiliate dashboard endpoints
   Problem: The dashboard endpoint is returning a different status for unauthenticated requests; tests expect 401.

Suggested fix (Next.js app route using NextAuth or server session retrieval):

- Check session/auth at the top of the handler and return a 401 JSON response if not authenticated.
- Avoid redirects to login pages for API routes — return 401.

Example using next-auth/getServerSession (adjust to your auth impl):

import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth'; // adapt path

export async function GET(request: Request) {
const session = await getServerSession(authOptions);

if (!session) {
return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

// authorized: fetch codes for session.user.id and return them
// const codes = await getAffiliateCodesForUser(session.user.id);
// return NextResponse.json({ codes });
}

Example plain check if using a cookie or token:

export default async function handler(req, res) {
const token = req.headers.authorization?.split(' ')[1] ?? req.cookies['token'];

if (!token) return res.status(401).json({ error: 'Unauthorized' });

// verify token -> if invalid: return 401
// else: fetch and return codes for authenticated user
}

Checklist:

- Ensure the API route does not cause a redirect for unauthenticated API consumers.
- Ensure all code paths return status 401 for unauthenticated requests (including missing Authorization header and invalid token/cookie).
- Make sure tests are calling the route in the same way (e.g., they expect 401 JSON, not HTML).

3. How to validate locally and rerun CI

- Run tests locally to confirm fixes:
  - npm ci && npm test
  - or yarn && yarn test
- Re-run the GitHub Actions workflow after committing the changes.

4. Additional notes from logs

- The job failed due to test failures (exit code 1). Codecov upload later hit a 429 but that did not cause the test failure.
- If you want, make the normalization and auth checks in small commits, so CI will show which change fixes which failing test.

Suggested minimal code edits to commit

- In the handler for POST /api/checkout/validate-code:
  - Add: const code = (body?.code ?? '').toString().trim().toUpperCase();
  - Use `code` for DB comparisons and responses.

- In the GET /api/affiliate/dashboard/codes handler:
  - Add early auth check and return status 401 JSON when no valid session/token.

If you want, share the specific handler files (path to the route files or paste the current handler code) and I will provide an exact patch diff you can commit.
