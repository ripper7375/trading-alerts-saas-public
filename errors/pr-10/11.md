Root cause

- The failing job (58539526730) is caused by two failing tests in **tests**/api/affiliate-dashboard.test.ts (the affiliate dashboard "codes" routes). The assertions that check pagination values are failing because the API route is returning the wrong page/limit values (page remains 1 instead of reading page=2, etc.).
- Logs show the test assertion failing at **tests**/api/affiliate-dashboard.test.ts line ~303 (expect(...).toBe). The tests set the request URL with query params (?page=2&limit=10), so the route must be parsing query params incorrectly (or returning pagination values derived from skip/take incorrectly).

What to change

1. Ensure the route reads query parameters from the request URL (not from headers or other sources), parses them as integers with base 10, and enforces minimums.
2. Compute skip/take consistently from parsed page/limit:
   - page = max(1, parseInt(pageParam || '1', 10))
   - limit = max(1, parseInt(limitParam || '20', 10))
   - skip = (page - 1) \* limit
3. Return the numeric page and limit in the response (not strings), so tests that assert data.page / data.limit get the expected numbers.

Suggested patch (replace pagination parsing + response pagination with this robust implementation)

File:

- app/api/affiliate/dashboard/codes/route.ts
  (Use this commit ref when opening the file: af657dbc09201f8407979c70b2804a1a2523ebc6)
  https://github.com/ripper7375/trading-alerts-saas-public/blob/af657dbc09201f8407979c70b2804a1a2523ebc6/app/api/affiliate/dashboard/codes/route.ts

Code to use inside the GET handler (TypeScript â€” adjust variable names to match your existing code):

const url = new URL(request.url); // safe for NextRequest or plain Request with .url
const pageParam = url.searchParams.get('page') ?? '1';
const limitParam = url.searchParams.get('limit') ?? '20';

// parse ints with base 10 and enforce minimums
const page = Math.max(1, parseInt(pageParam, 10) || 1);
const limit = Math.max(1, parseInt(limitParam, 10) || 20);

const skip = (page - 1) \* limit;

// example prisma query (adjust fields/filters to your implementation)
const [codes, total] = await Promise.all([
prisma.affiliateCode.findMany({
where: { affiliateProfileId: profile.id, /* other filters */ },
skip,
take: limit,
orderBy: { distributedAt: 'desc' },
}),
prisma.affiliateCode.count({
where: { affiliateProfileId: profile.id, /* same filters */ },
}),
]);

return NextResponse.json({
codes,
pagination: {
page, // numeric
limit, // numeric
total,
pages: Math.max(1, Math.ceil(total / limit)),
},
});

Notes and small defensive improvements

- Use new URL(request.url) rather than request.nextUrl if you need compatibility with tests that use a custom MockRequest. Tests in this repo create MockRequest with .url and .nextUrl; new URL(request.url) is robust.
- If the route previously computed page from skip/take the other way around (e.g., computing page after querying skip/take or using default skip=0), switch to the pattern above so page comes directly from the client query and is echoed back.
- Ensure you return page and limit as numbers (not strings) and include them either at top-level or inside pagination so tests expecting data.page/data.limit match.

Why this will fix the tests

- The tests construct a MockRequest with URL containing ?page=2&limit=10 and expect the response to include page=2 and limit=10 and that prisma.findMany was called with skip=10, take=10.
- The snippet above parses the query params and passes skip/take exactly as the test expects. It also returns numeric page/limit in the response for the test assertions.

Extra checks to run locally

- Run the specific test(s) locally to confirm the fix:
  - npx jest **tests**/api/affiliate-dashboard.test.ts -t "codes"
- Confirm mock expectations for prisma.findMany (skip/take) match after the change.

Other log items (non-blocking for this fix)

- The logs contain many console.error outputs from other tests that intentionally mock errors (DB errors, unauthorized, invalid tokens). Those are expected for tests asserting error handling and don't cause the test failures shown.
- Codecov upload warnings appear in the job logs (tokenless upload). Those are separate CI config issues and do not affect the unit test failures; handle that separately if you want to get code coverage uploads working.

If you want, I can prepare a minimal patch/PR patch snippet (diff) for the exact file at ref af657dbc09201f8407979c70b2804a1a2523ebc6 with the changes above.
