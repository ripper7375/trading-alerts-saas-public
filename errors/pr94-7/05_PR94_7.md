The failing test is Indicators API Routes › GET /api/indicators/[symbol]/[timeframe] › should return indicator data for FREE tier with valid symbol/timeframe, located in **tests**/api/indicators.test.ts at line 369, which expects a successful response for a FREE user accessing XAUUSD/H1.

Reviewing app/api/indicators/[symbol]/[timeframe]/route.ts, pay close attention to:

- The extraction/validation of symbol and timeframe (using Zod).
- The correct determination and passing of tier.
- The retrieval and caching logic for indicator data.

Checklist for the solution:

1. Ensure that FREE tier users are allowed to access XAUUSD and H1. The helper functions canAccessSymbol and canAccessTimeframe should return true for these when using the 'FREE' tier.
2. Confirm that symbol and timeframe normalization (e.g., uppercase conversion) is applied identically in both API and tests.
3. Stay aware of any subtle issues around parameter parsing—bars, tier, etc.

Common issues and fixes:

**Issue: canAccessSymbol or canAccessTimeframe Incorrectly Restricting Access**

- Validate in route.ts that 'XAUUSD' is listed in FREE_SYMBOLS and 'H1' in FREE_TIMEFRAMES.
- If the symbol/timeframe lists in '@/lib/tier-config' are missing 'XAUUSD' or 'H1' for the FREE tier, update FREE_SYMBOLS and FREE_TIMEFRAMES accordingly.

**Issue: Parameter Casing Mismatch**

- Ensure in route.ts that symbol and timeframe are normalized to uppercase before validation and before being passed to fetchIndicatorData and the cache:
  ```typescript
  const upperSymbol = symbolResult.data; // should be 'XAUUSD'
  const upperTimeframe = timeframeResult.data; // should be 'H1'
  ```
- Similarly, adjust the test (if needed) so that inputs are lowercase but assertions expect uppercase.

**Issue: Incorrect Tier Detection**

- Ensure session parsing logic for `userTier` (line 189) defaults to 'FREE' when missing.

**Example Fixes:**

- To robustly normalize parameters, adjust parameter extraction:
  ```typescript
  const symbolResult = symbolSchema
    .transform((val) => val.toUpperCase())
    .safeParse(rawSymbol);
  const timeframeResult = timeframeSchema
    .transform((val) => val.toUpperCase())
    .safeParse(rawTimeframe);
  ```
- Confirm FREE_SYMBOLS and FREE_TIMEFRAMES contain 'XAUUSD' and 'H1'. If missing, update '@/lib/tier-config':
  ```typescript
  export const FREE_SYMBOLS = ['XAUUSD', ...otherSymbols];
  export const FREE_TIMEFRAMES = ['H1', ...otherTimeframes];
  // etc.
  ```

If you confirm:

- FREE tier is permitted 'XAUUSD' and 'H1' via canAccessSymbol/canAccessTimeframe.
- Parameters are normalized to uppercase before validation and use.

The test should pass as expected.

For code reference, see:

- [**tests**/api/indicators.test.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/61cfdc556ed14f30da3501151e294b248bbbfe0d/__tests__/api/indicators.test.ts)
- [app/api/indicators/[symbol]/[timeframe]/route.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/61cfdc556ed14f30da3501151e294b248bbbfe0d/app/api/indicators/[symbol]/[timeframe]/route.ts)

After addressing these, rerun your tests to verify the fix.
