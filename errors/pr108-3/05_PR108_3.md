The failing job is caused by errors in tests for the Stripe webhook handlers, with failures specifically for:

- handleCheckoutCompleted: should upgrade user to PRO and create subscription
- handleSubscriptionDeleted: should downgrade user to FREE and revoke PRO permissions

From the logs and code, the failures all trace back to the implementation of handleSubscriptionDeleted in lib/stripe/webhook-handlers.ts (see line 254 for traceback). The integration test expects that downgrading a user to FREE and marking the subscription as CANCELED should also revoke all PRO permissions and set relevant user fields.

Potential causes:

- The webhook handler is calling sendSubscriptionCanceledEmail with four arguments (email, name, 'PRO', cancelAt, from [lines 254-258](https://github.com/ripper7375/trading-alerts-saas-public/blob/fdc72a6d6c5afaf7188024c9562bbf42cfb30e70/lib/stripe/webhook-handlers.ts#L254)), but the mock/integration test expects sendCancellationEmail to be called with only (email, name) (see test expectations at [lines 340-343](https://github.com/ripper7375/trading-alerts-saas-public/blob/fdc72a6d6c5afaf7188024c9562bbf42cfb30e70/__tests__/lib/stripe/webhook-handlers.test.ts#L340)). This causes a mismatch and can explain the test failures.
- The production code uses sendSubscriptionCanceledEmail, while the test mocks sendCancellationEmail. This discrepancy leads to mocks not being called as expected, causing test assertions to fail.

**Suggested Solution:**

1. Update your tests to mock sendSubscriptionCanceledEmail instead of sendCancellationEmail, or update the webhook-handlers.ts import to use sendCancellationEmail for consistency.
2. Ensure that arguments passed to the mocked email function in the test match the production signature, i.e. (email, name, tier, cancelAt).

Example for the test mock (in **tests**/lib/stripe/webhook-handlers.test.ts and **tests**/integration/tier1-workflows.test.ts):

```diff
- const mockSendCancellationEmail = jest.fn();
- jest.mock('@/lib/email/subscription-emails', () => ({
-   ...,
-   sendCancellationEmail: (...args) => mockSendCancellationEmail(...args),
- }));

+ const mockSendSubscriptionCanceledEmail = jest.fn();
+ jest.mock('@/lib/email/subscription-emails', () => ({
+   ...,
+   sendSubscriptionCanceledEmail: (...args) => mockSendSubscriptionCanceledEmail(...args),
+ }));
```

And update all assertions from mockSendCancellationEmail to mockSendSubscriptionCanceledEmail, using the correct signature.

Alternatively, align your webhook-handlers.ts to use sendCancellationEmail with the signature expected by your test suite.

**Reference:**

- [lib/stripe/webhook-handlers.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/fdc72a6d6c5afaf7188024c9562bbf42cfb30e70/lib/stripe/webhook-handlers.ts#L254)
- [**tests**/lib/stripe/webhook-handlers.test.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/fdc72a6d6c5afaf7188024c9562bbf42cfb30e70/__tests__/lib/stripe/webhook-handlers.test.ts)
- [**tests**/integration/tier1-workflows.test.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/fdc72a6d6c5afaf7188024c9562bbf42cfb30e70/__tests__/integration/tier1-workflows.test.ts)

Correct this inconsistency for the failing job to pass all tests.
