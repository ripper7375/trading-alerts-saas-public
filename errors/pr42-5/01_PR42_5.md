The failing job is caused by a TypeError: Cannot read properties of undefined (reading 'findMany') at lib/affiliate/constants.ts:125. This error indicates that the Prisma client (prisma.systemConfig) is undefined during the test run, causing the call to findMany to fail.

This issue occurs because in your test (**tests**/api/admin-reports.test.ts), you are mocking only the prisma.commission.findMany method but the production code in lib/affiliate/constants.ts uses prisma.systemConfig.findMany as well. The test does not provide this mock, causing it to be undefined during tests that invoke getAffiliateConfigFromDB.

**Solution: Update your test mock for prisma to include systemConfig with findMany:**

Edit your mock in **tests**/api/admin-reports.test.ts as follows:

```typescript
// Add at the top with your other mocks
const mockFindMany = jest.fn();

// Update your prisma mock to include systemConfig
jest.mock('@/lib/db/prisma', () => ({
  __esModule: true,
  prisma: {
    commission: {
      findMany: (...args: unknown[]) => mockFindMany(...args),
    },
    // Add this block
    systemConfig: {
      findMany: jest.fn().mockResolvedValue([
        // Return suitable config objects as test defaults
        { key: 'affiliate_discount_percent', value: '20.0' },
        { key: 'affiliate_commission_percent', value: '20.0' },
        { key: 'affiliate_codes_per_month', value: '15' },
        { key: 'affiliate_base_price', value: '29.0' },
      ]),
    },
  },
}));
```

This will prevent the "undefined" error and allow getAffiliateConfigFromDB to run as expected in tests.

**Summary of fix:**

- Mock `prisma.systemConfig.findMany` in your test file.
- Provide suitable defaults so your config fetch succeeds.

See: [lib/affiliate/constants.ts (ref: e658480707057c52b3ddcea1dd1bd03502dc7cfc)](https://github.com/ripper7375/trading-alerts-saas-public/blob/e658480707057c52b3ddcea1dd1bd03502dc7cfc/lib/affiliate/constants.ts)  
See: [**tests**/api/admin-reports.test.ts (ref: e658480707057c52b3ddcea1dd1bd03502dc7cfc)](https://github.com/ripper7375/trading-alerts-saas-public/blob/e658480707057c52b3ddcea1dd1bd03502dc7cfc/__tests__/api/admin-reports.test.ts)

This change should resolve the failing job.
