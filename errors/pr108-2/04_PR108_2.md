The job failed due to errors in the handling of Stripe subscription webhooks, particularly for subscription cancellation and downgrades. The failure in tests and code is linked to the function handleSubscriptionDeleted in lib/stripe/webhook-handlers.ts.

**Solution:**

1. **Subscription Downgrade Logic:**  
   Ensure handleSubscriptionDeleted correctly handles all edge cases, especially when the Stripe subscription or user record is missing required fields or nulls. The code is mostly correct but tests expect sendCancellationEmail, while production code calls sendSubscriptionCanceledEmail, leading to failed expectations.
   - Update the integration and unit tests to expect sendSubscriptionCanceledEmail (or change the function name in the handler for naming consistency).

2. **Test Correction Example:**
   In **tests**/lib/stripe/webhook-handlers.test.ts, replace calls like:

   ```typescript
   expect(mockSendCancellationEmail).toHaveBeenCalledWith(
     'user@example.com',
     'Test User'
   );
   ```

   with

   ```typescript
   expect(mockSendSubscriptionCanceledEmail).toHaveBeenCalledWith(
     'user@example.com',
     'Test User',
     'PRO',
     expect.any(Date)
   );
   ```

   Ensure mockSendSubscriptionCanceledEmail is mocked properly.

3. **Handler Name Consistency:**  
   In lib/stripe/webhook-handlers.ts, if the intended behavior is to use sendSubscriptionCanceledEmail, update the tests. If it should be sendCancellationEmail, update the import in the handler:

   ```typescript
   import { sendCancellationEmail } from '@/lib/email/subscription-emails';
   // And call sendCancellationEmail in handleSubscriptionDeleted
   ```

4. **Code Suggestion for Safety:**  
   To further bulletproof handleSubscriptionDeleted, check for all possible nulls before sending emails:
   ```typescript
   if (dbSubscription.user && dbSubscription.user.email) {
     await sendSubscriptionCanceledEmail(
       dbSubscription.user.email,
       dbSubscription.user.name || 'User',
       'PRO',
       cancelAt
     );
   }
   ```

**Summary:**  
Sync the handler function and test expectations for cancellation emails. This will fix the mismatch causing the failures in both unit and integration tests, and ensure the codebase is consistent and robust. For reference, see handleSubscriptionDeleted in lib/stripe/webhook-handlers.ts and its related tests in **tests**/lib/stripe/webhook-handlers.test.ts (ref: 8e07e6af7183527dc86467af671a2ee697149d03).
