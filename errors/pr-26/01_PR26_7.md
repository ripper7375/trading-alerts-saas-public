The main failures in job 58689600520 are due to "Database error" exceptions in several API test cases, most notably in:

- **tests**/api/admin-affiliates.test.ts
- **tests**/api/admin-reports.test.ts
- **tests**/api/admin.test.ts

as well as a specific failure in:

- **tests**/api/disbursement/batches/route.test.ts ("GET /api/disbursement/batches â€º should return all batches for admin")

### Solution:

1. **Database Mocking for API Tests**:  
   Your tests are failing because the API endpoints (for admin affiliates, reports, users, etc.) try to access a database, and during CI there is likely no real database available. Update the affected test files to properly mock database access or inject a test database.
   - Use tools/libraries like `jest.mock()` or `ts-mockito` to mock your ORM/database calls (e.g., Prisma, Sequelize, TypeORM, etc.).
   - If using a custom database module, mock its methods to return controlled test data instead of throwing errors.

   Example for Jest (replace `db.getAffiliates` with your actual data access method):

   ```ts
   // At the top of __tests__/api/admin-affiliates.test.ts
   jest.mock('../../path/to/db', () => ({
     getAffiliates: jest.fn().mockResolvedValue([
       // your mock data here
     ]),
     // ...mock other methods as needed
   }));
   ```

2. **Check Environment Variables**:  
   Ensure that any environment variables needed for DB connections in test mode are set, or that your test config disables external connections.

3. **Isolate Integration vs Unit Tests**:  
   Separate tests requiring an actual database (integration) from pure unit tests. In the CI, only run integration tests if a test DB is provisioned.

4. **Review Disbursement Batches Test**:  
   For `__tests__/api/disbursement/batches/route.test.ts`, ensure all batch-related database calls are mocked or a seeded test DB is available.

### Quick Fix Example for Affiliate API Test

```ts
jest.mock('../../../app/api/admin/affiliates/db', () => ({
  fetchAffiliates: jest.fn().mockResolvedValue([
    { id: 1, name: 'Aff One' },
    // more mock objects
  ]),
}));
```

Add this to the start of your test file or use a test setup file.

---

**Next Steps**:

- Implement similar mocks for all failing test suites that do DB access.
- If the problem is with integrations, ensure a test DB is available and seeded in your CI setup.
- Rerun the workflow to confirm all tests pass.

If you need help with the specific code in a test or route, let me know which file to review in detail!
