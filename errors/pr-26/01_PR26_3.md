Based on the logs for job 58673897410, the core issues causing test failures are due to unhandled errors—primarily "Database error"—in admin API routes and disbursement batch logic. Here’s how you can address the core causes:

## 1. Fix Unhandled "Database error" in API Routes

Multiple tests, including affiliates, users, and P&L reports, fail because "Database error" is thrown and caught, returning status 500. These failures can be resolved by:

- Ensuring test DB configuration and seeded data exist for tests.
- Adding error handling and more specific error messages in the route handlers to facilitate debugging.

**Example fix for route handler error logging:**

```ts
// app/api/admin/affiliates/route.ts
try {
  // existing DB call
} catch (error) {
  console.error('Admin affiliates list error:', error);
  // Suggest: log error.stack for more context
  return NextResponse.json(
    { error: error instanceof Error ? error.message : 'Unknown error' },
    { status: 500 }
  );
}
```

Do the same for users and report routes to get specific error details.

## 2. Ensure Test Database Connection

These errors usually arise in CI due to absence or misconfiguration of the test database.

- Make sure there is a running test database, available in the CI environment.
- Validate the test DB URL/environment variables.
- Seed the DB with required test data.

## 3. Fix Disbursement Batch Logic Failing in Tests

Some tests in `__tests__/lib/disbursement/services/batch.test.ts` and `__tests__/api/disbursement/batches/execute.test.ts` also fail, possibly due to improper test setup or missing mocks for dependencies.

**Example improvement for batches test (Jest):**

```ts
// __tests__/api/disbursement/batches/route.test.ts
beforeAll(async () => {
  // Mock/seed data required for batch processing,
  // or mock external dependencies/services as needed
});
```

## 4. Code Coverage Report Error

Codecov fails due to missing `coverage/lcov.info`. Make sure your test run actually generates coverage reports:

- In `package.json` test script, use: `"test": "jest --coverage"`
- Confirm coverage output path matches Codecov expectation.

---

**Summary of actions:**

1. Add specific error logging and always return actual error messages from handlers.
2. Ensure the test DB is available, seeded, and all environment variables are present in CI.
3. Mock services and provide necessary test data for disbursement batch/services tests.
4. Confirm your test script outputs a coverage report at the path expected by Codecov.

If you need help with a specific file or line (like "route.ts:93" or test setup), let me know! Links for quick navigation:

- [app/api/admin/affiliates/route.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/d02fbf4150afe4b7fc348e23bfa91576bfa7e519/app/api/admin/affiliates/route.ts)
- [**tests**/api/admin-affiliates.test.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/d02fbf4150afe4b7fc348e23bfa91576bfa7e519/__tests__/api/admin-affiliates.test.ts)
- [lib/logger.ts](https://github.com/ripper7375/trading-alerts-saas-public/blob/d02fbf4150afe4b7fc348e23bfa91576bfa7e519/lib/logger.ts)

Apply these suggestions and rerun your CI for more detailed error traces and to resolve the root cause.
