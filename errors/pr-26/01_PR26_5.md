The failing job (58683911919) is caused by several test failures. Here's a summary of the most critical failures and recommended solutions:

---

### 1. **tests**/api/disbursement/batches/route.test.ts

**Error:**

- Test: `GET /api/disbursement/batches › should return all batches for admin`
- Failure at an assertion: `.toBe()` failed (likely a value mismatch).
- Related code: Route handler for `/api/disbursement/batches`.

**Recommended Solution:**

- Check the test expectation in [`__tests__/api/disbursement/batches/route.test.ts`](https://github.com/ripper7375/trading-alerts-saas-public/blob/d16a1ab19e1ecbb972faeb4d0cf9463a0d6ecdbe/__tests__/api/disbursement/batches/route.test.ts).
- Ensure the route handler in [`app/api/disbursement/batches/route.ts`](https://github.com/ripper7375/trading-alerts-saas-public/blob/d16a1ab19e1ecbb972faeb4d0cf9463a0d6ecdbe/app/api/disbursement/batches/route.ts) returns the expected shape and status. Most likely, the database call is returning no data or an unexpected error (possibly due to mocks not being set up correctly in the test).

**Action:**

- Update the test's input mocks or the route handler's response to align with what the test expects.
- If using a mock database, ensure it returns example data for admin users.

---

### 2. **tests**/lib/disbursement/services/batch.test.ts

**Error:**

- Test: `BatchManager › createBatch › should create a payment batch with correct totals`
- Failure at an assertion: `.toHaveBeenCalledWith` (likely a mismatch in called arguments, especially `totalAmount`).

**Recommended Solution:**

- Verify calculation logic of `totalAmount` in the BatchManager implementation.
- Double-check the test data in [`__tests__/lib/disbursement/services/batch.test.ts`](https://github.com/ripper7375/trading-alerts-saas-public/blob/d16a1ab19e1ecbb972faeb4d0cf9463a0d6ecdbe/__tests__/lib/disbursement/services/batch.test.ts).
- Make sure that rounding/precision matches between the test data and calculation logic (use `toFixed()` or similar if necessary).

---

### 3. **tests**/lib/disbursement/services/orchestrator.test.ts

**Error:**

- Test: `PaymentOrchestrator › executeBatch › should execute batch with all successful payments`
- Failure on a `.mockResolvedValue()` assertion or possible unhandled rejection.

**Recommended Solution:**

- Ensure all mocked promises in the test are set up to resolve successfully.
- Make sure the orchestrator service properly handles resolved promises in the production code.

---

### 4. Code Coverage Upload Errors

- Codecov upload failed: "Token required - not valid tokenless upload".
- This is not a test failure but a CI configuration issue.
- Solution: Add the Codecov token to your repository's secrets (see Codecov docs for details).

---

## Most likely root cause for the main test failures:

- API routes are returning errors (500) due to missing, mocked, or misconfigured database/data-service calls.
- Test expectations for return values or function calls are mismatched with what implementation actually provides.

---

## Example Fix: Batch Route Test

If the test expects an array of batch objects:

```diff
- return NextResponse.json({ batches: result }, { status: 200 });
+ return NextResponse.json(result, { status: 200 });
```

Or update the test to expect `{ batches: [...] }` if your API deliberately wraps the response.

For database mocks, in your test setup:

```js
jest.spyOn(db, 'getBatches').mockResolvedValue([
  { id: 1, ... },
  { id: 2, ... },
]);
```

---

Apply similar check/fix for the other test/services as above. If you need code for a specific place, let me know which failing test file you want to see the fix for.
