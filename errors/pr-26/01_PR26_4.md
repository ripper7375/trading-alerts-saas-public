Based on the job logs for 58683147946, these are the main failing points and solutions:

### 1. Database Error in API Endpoints

Several tests fail with errors like:

- "Admin affiliates list error: Error: Database error" at app/api/admin/affiliates/route.ts:93
- "Admin P&L report error: Error: Database error" at app/api/admin/affiliates/reports/profit-loss/route.ts:162
- "Admin users error: Error: Database error" at app/api/admin/users/route.ts:185

**Solution:** These API handlers are not gracefully handling database failures. Improve error handling and add mocks for database interactions in the tests.

**Code suggestion:** In your test setup, ensure the database client is mocked and returns expected data, not failures, unless explicitly testing error cases. Example for Jest:

```ts
// __mocks__/database.ts
export const getAffiliates = jest
  .fn()
  .mockResolvedValue([{ id: 1, name: 'test affiliate' }]);
jest.mock('../../path/to/database', () => ({
  ...jest.requireActual('../../path/to/database'),
  getAffiliates,
}));
```

In your API, enhance catch blocks:

```ts
try {
  // db call
} catch (error) {
  console.error('Admin affiliates list error:', error);
  return NextResponse.json(
    { error: 'Failed to fetch affiliates' },
    { status: 500 }
  );
}
```

Make sure the tests initialize these mocks.

---

### 2. BatchManager Test Failure

- Fails at lib/disbursement/services/batch-manager.ts:122
- Error creating payment batch; likely a logic or mock data issue.

**Solution:** Review the batch creation logic and test data. Ensure test provides the necessary input structure.

**Code suggestion:** In your test, ensure that all required fields for batch creation are provided:

```ts
const input = {
  payments: [
    {
      /* required payment data */
    },
  ],
  // other required properties
};

expect(() => batchManager.createBatch(input)).not.toThrow();
```

If the method expects specific keys or non-empty arrays, reflect that in the test data.

---

### 3. PaymentOrchestrator Test Failure

- Fails on orchestrator logic (executeBatch)
- Ensure mocks are set up for all external dependencies.

**Solution:** Stub all external service calls and database interactions the orchestrator uses.

**Code suggestion:**

```ts
jest
  .spyOn(ServiceClass.prototype, 'externalMethod')
  .mockResolvedValue(mockResult);
```

---

### 4. Codecov Action Failure

- Error: Token required - not valid tokenless upload

**Solution:** Add a CODECOV_TOKEN secret to your repositoryâ€™s GitHub Actions secrets.

1. Go to repo Settings > Secrets and variables > Actions
2. Add CODECOV_TOKEN with your token from https://app.codecov.io/

---

### 5. "Failed to fetch exchange rate" warnings

- These are logged as warnings, not causing test failures.
- If you want to avoid noise, mock the function that fetches exchange rates to always return a valid value in tests.

---

## Summary of Actions:

- Mock database and external service calls in tests to avoid "Database error".
- Update test data to match requirements in batch and orchestrator tests.
- Add CODECOV_TOKEN to GitHub secrets for Codecov upload.
- Optionally mock exchange rate API calls in tests.

If you provide the failing lines from the relevant files (`app/api/admin/affiliates/route.ts`, etc.), I can give more precise code fixes. Let me know if you want that next.
