I'll analyze the failing job to find a solution. Let me start by getting the job logs. Now let me look at the failing test files to understand the issues: ## Solution for Failing Tests

The tests are failing due to **type incompatibility in the `getAllBatches` method** on line 247 of `batch-manager.ts`. The method is using `.map()` directly on the batches array returned from Prisma, but the TypeScript compiler doesn't recognize it as having a `.map` method.

### Root Cause

Looking at the error in the logs:

```
at BatchManager.map [as getAllBatches] (lib/disbursement/services/batch-manager.ts:247:20)
```

Line 247 is trying to call `.map()` on the `batches` result, but the Prisma query result type isn't being properly inferred.

### Fix

Update the `getAllBatches` method in `lib/disbursement/services/batch-manager.ts`:

```typescript
async getAllBatches(
  status?: BatchStatus,
  limit:  number = 50
): Promise<PaymentBatchWithTransactions[]> {
  const batches = await this.prisma.paymentBatch.findMany({
    where: status ? { status } :  undefined,
    orderBy: { createdAt: 'desc' },
    take: limit,
    include: {
      transactions:  {
        select: {
          id: true,
          status:  true,
          amount: true,
        },
      },
    },
  });

  // Ensure batches is treated as an array before mapping
  return Array.from(batches).map((batch) => ({
    id: batch.id,
    batchNumber: batch.batchNumber,
    paymentCount:  batch.paymentCount,
    totalAmount: Number(batch.totalAmount),
    currency: batch. currency,
    provider: batch. provider,
    status: batch. status,
    scheduledAt:  batch.scheduledAt,
    executedAt: batch.executedAt,
    completedAt:  batch.completedAt,
    failedAt: batch.failedAt,
    errorMessage: batch.errorMessage,
    createdAt: batch.createdAt,
    updatedAt: batch. updatedAt,
    transactions:  batch.transactions.map((t) => ({
      id: t. id,
      status: t. status,
      amount: Number(t.amount),
    })),
  }));
}
```

Alternatively, you can explicitly type the result:

```typescript
const batches = (await this.prisma.paymentBatch.findMany({
  where: status ? { status } : undefined,
  orderBy: { createdAt: 'desc' },
  take: limit,
  include: {
    transactions: {
      select: {
        id: true,
        status: true,
        amount: true,
      },
    },
  },
})) as Array<any>; // or provide proper type
```

This issue affects the test at line 336 in `__tests__/lib/disbursement/services/batch. test.ts` where `getAllBatches` is called, causing the runtime error that propagates to the API tests as well.
