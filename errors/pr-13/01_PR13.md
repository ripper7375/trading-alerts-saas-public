The failure occurred because generateAffiliateReport in app/api/cron/send-monthly-reports/route.ts expects prisma.commission.aggregate but your **tests**/api/cron-jobs.test.ts mock defines prisma.affiliateCommission.aggregate. As a result, during test execution, prisma.commission is undefined and calling aggregate throws: Cannot read properties of undefined (reading 'aggregate').

To fix this, update the mock in **tests**/api/cron-jobs.test.ts lines 41â€“55:

Replace:

```typescript
prisma: {
  affiliateCode: { ... },
  affiliateProfile: { ... },
  affiliateCommission: {
    aggregate: (...args: unknown[]) => mockCommissionAggregate(...args),
  },
},
```

With:

```typescript
prisma: {
  affiliateCode: { ... },
  affiliateProfile: { ... },
  commission: {
    aggregate: (...args: unknown[]) => mockCommissionAggregate(...args),
  },
},
```

This ensures the prisma.commission.aggregate used in your route matches the test mock, resolving the TypeError.

See the code: app/api/cron/send-monthly-reports/route.ts (ref: 6c64151c8facd79ac3813baea0e59d77645e1591)
