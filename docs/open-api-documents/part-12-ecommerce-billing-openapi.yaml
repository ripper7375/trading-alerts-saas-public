openapi: 3.0.3
info:
  title: Trading Alerts SaaS - E-commerce & Billing API (Part 12)
  version: 1.0.0
  description: |
    E-commerce and Billing API for Trading Alerts SaaS platform (Part 12).

    This API provides subscription management, checkout, payment processing, and billing operations.

    ## Features
    - Stripe and dLocal payment integration
    - Subscription management (create, cancel, view)
    - Checkout session creation
    - Invoice management
    - Webhook handling for payment events
    - Affiliate code validation and tracking

    ## Payment Providers
    - **Stripe**: Primary payment processor (global)
    - **dLocal**: Alternative payment processor (specific regions)

    ## Subscription Plans
    - **FREE**: No payment required
    - **PRO Monthly**: $29/month recurring
    - **PRO 3-Day**: $3 for 3 days (trial/promotional)

  contact:
    name: API Support
    email: support@tradingalerts.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://api.tradingalerts.example.com
    description: Production server

security:
  - sessionAuth: []

tags:
  - name: Subscription
    description: Subscription management
  - name: Checkout
    description: Checkout and payment processing
  - name: Invoices
    description: Invoice retrieval
  - name: Webhooks
    description: Payment provider webhooks

paths:
  /api/subscription:
    get:
      tags:
        - Subscription
      summary: Get current subscription
      description: |
        Retrieves the user's current subscription details including payment method and status.

        **Supports:**
        - Stripe subscriptions
        - dLocal subscriptions
        - FREE tier (no subscription)
      operationId: getSubscription
      responses:
        '200':
          description: Subscription retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
              examples:
                freeUser:
                  summary: FREE tier user
                  value:
                    tier: "FREE"
                    status: "none"
                    subscription: null
                stripeProUser:
                  summary: PRO tier with Stripe
                  value:
                    tier: "PRO"
                    status: "active"
                    subscription:
                      id: "sub_1234567890"
                      status: "active"
                      provider: "STRIPE"
                      planType: "MONTHLY"
                      currentPeriodEnd: "2026-01-20T00:00:00.000Z"
                      expiresAt: null
                      cancelAtPeriodEnd: false
                      trialEnd: null
                      paymentMethod:
                        brand: "visa"
                        last4: "4242"
                        expiryMonth: 12
                        expiryYear: 2026
                      dLocalPaymentMethod: null
                      dLocalCountry: null
                dLocalProUser:
                  summary: PRO tier with dLocal
                  value:
                    tier: "PRO"
                    status: "active"
                    subscription:
                      id: "dl_abc123"
                      status: "active"
                      provider: "DLOCAL"
                      planType: "THREE_DAY"
                      currentPeriodEnd: null
                      expiresAt: "2025-12-23T00:00:00.000Z"
                      cancelAtPeriodEnd: false
                      trialEnd: null
                      paymentMethod: null
                      dLocalPaymentMethod: "pix"
                      dLocalCountry: "BR"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/subscription/cancel:
    post:
      tags:
        - Subscription
      summary: Cancel subscription
      description: |
        Cancels the user's active subscription.

        **Behavior:**
        - Subscription remains active until end of billing period
        - Sets `cancelAtPeriodEnd` to true
        - User retains PRO access until expiration
        - Works with both Stripe and dLocal subscriptions
      operationId: cancelSubscription
      responses:
        '200':
          description: Subscription cancelled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelSubscriptionResponse'
              example:
                message: "Subscription cancelled successfully"
                cancelAtPeriodEnd: true
                currentPeriodEnd: "2026-01-20T00:00:00.000Z"
        '400':
          description: No active subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noSubscription:
                  summary: No subscription found
                  value:
                    error: "No subscription"
                    message: "No active subscription found to cancel"
                    code: "NO_SUBSCRIPTION"
                alreadyCancelled:
                  summary: Already cancelled
                  value:
                    error: "Already cancelled"
                    message: "Subscription is already set to cancel"
                    code: "ALREADY_CANCELLED"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/checkout:
    post:
      tags:
        - Checkout
      summary: Create checkout session
      description: |
        Creates a Stripe Checkout session for upgrading to PRO tier.

        **Process:**
        1. Validates user is not already PRO
        2. Optionally validates affiliate code
        3. Creates Stripe Checkout session
        4. Returns redirect URL to Stripe payment page

        **After Payment:**
        - Stripe webhook updates subscription
        - User is redirected to success/cancel URL
      operationId: createCheckoutSession
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutRequest'
            examples:
              withoutAffiliateCode:
                summary: Checkout without affiliate
                value: {}
              withAffiliateCode:
                summary: Checkout with affiliate code
                value:
                  affiliateCode: "PARTNER123"
      responses:
        '200':
          description: Checkout session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'
              example:
                sessionId: "cs_test_a1b2c3d4e5f6g7h8i9j0"
                url: "https://checkout.stripe.com/pay/cs_test_a1b2c3d4e5f6g7h8i9j0"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyPro:
                  summary: User already has PRO
                  value:
                    error: "Already subscribed"
                    message: "You are already on the PRO tier"
                    code: "ALREADY_PRO"
                emailRequired:
                  summary: Email missing
                  value:
                    error: "Email required"
                    message: "Your account must have an email address to upgrade"
                    code: "EMAIL_REQUIRED"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/checkout/validate-code:
    post:
      tags:
        - Checkout
      summary: Validate affiliate code
      description: |
        Validates an affiliate promotional code before checkout.

        **Returns:**
        - Code validity
        - Affiliate information
        - Discount information (if applicable)
      operationId: validateAffiliateCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateCodeRequest'
            example:
              code: "PARTNER123"
      responses:
        '200':
          description: Code validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateCodeResponse'
              examples:
                validCode:
                  summary: Valid affiliate code
                  value:
                    valid: true
                    code: "PARTNER123"
                    affiliateName: "Tech Partner"
                    discount: null
                invalidCode:
                  summary: Invalid code
                  value:
                    valid: false
                    error: "Code not found or inactive"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/invoices:
    get:
      tags:
        - Invoices
      summary: List user's invoices
      description: |
        Retrieves all invoices for the authenticated user's subscription.

        **Includes:**
        - Invoice ID and number
        - Amount and currency
        - Payment status
        - Invoice date
        - Download URL (PDF)
      operationId: getInvoices
      responses:
        '200':
          description: Invoices retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoicesResponse'
              example:
                invoices:
                  - id: "in_1234567890"
                    number: "INV-2025-001"
                    amount: 2900
                    currency: "usd"
                    status: "paid"
                    date: "2025-12-20T00:00:00.000Z"
                    pdfUrl: "https://pay.stripe.com/invoice/acct_xxx/test_xxx/pdf"
                  - id: "in_0987654321"
                    number: "INV-2025-002"
                    amount: 2900
                    currency: "usd"
                    status: "paid"
                    date: "2025-11-20T00:00:00.000Z"
                    pdfUrl: "https://pay.stripe.com/invoice/acct_xxx/test_xxx/pdf"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/webhooks/stripe:
    post:
      tags:
        - Webhooks
      summary: Stripe webhook handler
      description: |
        Handles Stripe webhook events for subscription and payment updates.

        **Handled Events:**
        - `checkout.session.completed`: New subscription created
        - `customer.subscription.updated`: Subscription modified
        - `customer.subscription.deleted`: Subscription cancelled
        - `invoice.payment_succeeded`: Payment successful
        - `invoice.payment_failed`: Payment failed

        **Security:**
        - Validates Stripe signature
        - Rejects invalid signatures (401)
      operationId: handleStripeWebhook
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe webhook event payload
      parameters:
        - name: stripe-signature
          in: header
          required: true
          description: Stripe webhook signature
          schema:
            type: string
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Invalid signature or event
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Webhook processing error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: next-auth.session-token
      description: NextAuth session cookie

  schemas:
    SubscriptionResponse:
      type: object
      required:
        - tier
        - status
      properties:
        tier:
          type: string
          enum: [FREE, PRO]
          description: User's current tier
          example: "PRO"
        status:
          type: string
          description: Subscription status
          example: "active"
        subscription:
          $ref: '#/components/schemas/Subscription'

    Subscription:
      type: object
      nullable: true
      properties:
        id:
          type: string
          description: Subscription ID
          example: "sub_1234567890"
        status:
          type: string
          description: Subscription status
          example: "active"
        provider:
          type: string
          enum: [STRIPE, DLOCAL]
          nullable: true
          description: Payment provider
          example: "STRIPE"
        planType:
          type: string
          enum: [MONTHLY, THREE_DAY]
          nullable: true
          description: Subscription plan type
          example: "MONTHLY"
        currentPeriodEnd:
          type: string
          format: date-time
          nullable: true
          description: Current billing period end (Stripe)
          example: "2026-01-20T00:00:00.000Z"
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: Subscription expiration (dLocal)
          example: "2025-12-23T00:00:00.000Z"
        cancelAtPeriodEnd:
          type: boolean
          description: Whether subscription cancels at period end
          example: false
        trialEnd:
          type: string
          format: date-time
          nullable: true
          description: Trial period end date
          example: null
        paymentMethod:
          $ref: '#/components/schemas/PaymentMethod'
        dLocalPaymentMethod:
          type: string
          nullable: true
          description: dLocal payment method type
          example: "pix"
        dLocalCountry:
          type: string
          nullable: true
          description: dLocal country code
          example: "BR"

    PaymentMethod:
      type: object
      nullable: true
      properties:
        brand:
          type: string
          description: Card brand
          example: "visa"
        last4:
          type: string
          description: Last 4 digits
          example: "4242"
        expiryMonth:
          type: integer
          description: Expiry month
          example: 12
        expiryYear:
          type: integer
          description: Expiry year
          example: 2026

    CancelSubscriptionResponse:
      type: object
      required:
        - message
        - cancelAtPeriodEnd
      properties:
        message:
          type: string
          example: "Subscription cancelled successfully"
        cancelAtPeriodEnd:
          type: boolean
          example: true
        currentPeriodEnd:
          type: string
          format: date-time
          nullable: true
          example: "2026-01-20T00:00:00.000Z"

    CheckoutRequest:
      type: object
      properties:
        affiliateCode:
          type: string
          description: Optional affiliate promotional code
          example: "PARTNER123"

    CheckoutResponse:
      type: object
      required:
        - sessionId
        - url
      properties:
        sessionId:
          type: string
          description: Stripe Checkout session ID
          example: "cs_test_a1b2c3d4e5f6g7h8i9j0"
        url:
          type: string
          format: uri
          description: Stripe Checkout URL to redirect user
          example: "https://checkout.stripe.com/pay/cs_test_a1b2c3d4e5f6g7h8i9j0"

    ValidateCodeRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          description: Affiliate code to validate
          example: "PARTNER123"

    ValidateCodeResponse:
      type: object
      required:
        - valid
      properties:
        valid:
          type: boolean
          example: true
        code:
          type: string
          example: "PARTNER123"
        affiliateName:
          type: string
          example: "Tech Partner"
        discount:
          type: object
          nullable: true
          properties:
            percentage:
              type: number
              example: 10
            amount:
              type: number
              example: 5
        error:
          type: string
          example: "Code not found or inactive"

    InvoicesResponse:
      type: object
      required:
        - invoices
      properties:
        invoices:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'

    Invoice:
      type: object
      required:
        - id
        - amount
        - currency
        - status
        - date
      properties:
        id:
          type: string
          description: Invoice ID
          example: "in_1234567890"
        number:
          type: string
          description: Invoice number
          example: "INV-2025-001"
        amount:
          type: integer
          description: Amount in cents
          example: 2900
        currency:
          type: string
          description: Currency code
          example: "usd"
        status:
          type: string
          description: Payment status
          enum: [paid, open, void, uncollectible]
          example: "paid"
        date:
          type: string
          format: date-time
          description: Invoice date
          example: "2025-12-20T00:00:00.000Z"
        pdfUrl:
          type: string
          format: uri
          description: PDF download URL
          example: "https://pay.stripe.com/invoice/acct_xxx/test_xxx/pdf"

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Unauthorized"
        message:
          type: string
          description: Detailed error message
          example: "You must be logged in"
        code:
          type: string
          description: Error code
          example: "UNAUTHORIZED"
