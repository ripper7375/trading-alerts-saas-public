name: Security Checks

# Comprehensive security checks for pre-launch validation
# Runs on all PRs and pushes to main/claude branches

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  security-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "üîç Running pnpm security audit..."
          pnpm audit --audit-level=high
          echo "‚úÖ No high/critical vulnerabilities found"

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: |
          echo "üîç Running TypeScript type check..."
          pnpm run type-check
          echo "‚úÖ No type errors found"

  lint:
    name: ESLint Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint..."
          pnpm run lint
          echo "‚úÖ No linting errors found"

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets
        run: |
          echo "üîç Scanning for hardcoded secrets..."

          # Check for common secret patterns
          FOUND=0

          # Stripe keys
          if grep -rE "sk_live_[A-Za-z0-9]{20,}" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next .; then
            echo "‚ùå Found potential Stripe live key"
            FOUND=1
          fi

          # AWS keys
          if grep -rE "AKIA[A-Z0-9]{16}" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next .; then
            echo "‚ùå Found potential AWS key"
            FOUND=1
          fi

          # GitHub tokens
          if grep -rE "ghp_[A-Za-z0-9]{36}" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next .; then
            echo "‚ùå Found potential GitHub token"
            FOUND=1
          fi

          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ No hardcoded secrets detected"
          else
            echo "‚ùå Potential secrets found - please review"
            exit 1
          fi

  security-headers-check:
    name: Security Headers Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate security headers in config
        run: |
          echo "üîç Checking security headers configuration..."

          # Check for required headers in next.config.js
          MISSING=0

          if ! grep -q "Strict-Transport-Security" next.config.js; then
            echo "‚ùå Missing HSTS header"
            MISSING=1
          fi

          if ! grep -q "Content-Security-Policy" next.config.js; then
            echo "‚ùå Missing CSP header"
            MISSING=1
          fi

          if ! grep -q "X-Frame-Options" next.config.js; then
            echo "‚ùå Missing X-Frame-Options header"
            MISSING=1
          fi

          if ! grep -q "X-Content-Type-Options" next.config.js; then
            echo "‚ùå Missing X-Content-Type-Options header"
            MISSING=1
          fi

          if [ $MISSING -eq 0 ]; then
            echo "‚úÖ All required security headers configured"
          else
            echo "‚ùå Some security headers missing"
            exit 1
          fi

  summary:
    name: Security Check Summary
    runs-on: ubuntu-latest
    needs: [security-audit, type-check, lint, secrets-scan, security-headers-check]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "üîê Security Check Summary"
          echo "========================="
          echo ""

          if [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "‚úÖ Dependency audit: PASSED"
          else
            echo "‚ùå Dependency audit: FAILED"
          fi

          if [ "${{ needs.type-check.result }}" == "success" ]; then
            echo "‚úÖ Type check: PASSED"
          else
            echo "‚ùå Type check: FAILED"
          fi

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "‚úÖ Linting: PASSED"
          else
            echo "‚ùå Linting: FAILED"
          fi

          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "‚úÖ Secrets scan: PASSED"
          else
            echo "‚ùå Secrets scan: FAILED"
          fi

          if [ "${{ needs.security-headers-check.result }}" == "success" ]; then
            echo "‚úÖ Security headers: PASSED"
          else
            echo "‚ùå Security headers: FAILED"
          fi

          echo ""

          # Fail if any check failed
          if [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.secrets-scan.result }}" != "success" ] || \
             [ "${{ needs.security-headers-check.result }}" != "success" ]; then
            echo "‚ùå Some security checks failed"
            exit 1
          fi

          echo "‚úÖ All security checks passed!"
